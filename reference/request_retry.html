<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Make a Google API request, repeatedly — request_retry • gargle</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Make a Google API request, repeatedly — request_retry" />
<meta property="og:description" content="Intended primarily for internal use in client packages that provide
high-level wrappers for users. It is a drop-in substitute for
request_make() that also has the ability to retry the request." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gargle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/non-interactive-auth.html">Non-interactive auth</a>
    </li>
    <li>
      <a href="../articles/troubleshooting.html">Troubleshooting gargle auth</a>
    </li>
    <li>
      <a href="../articles/auth-from-web.html">Auth when using R in the browser</a>
    </li>
    <li>
      <a href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../articles/index.html">More...</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Blog posts</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a>
    </li>
    <li class="divider"></li>
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/gargle/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Make a Google API request, repeatedly</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/gargle/blob/master/R/request_retry.R'><code>R/request_retry.R</code></a></small>
    <div class="hidden name"><code>request_retry.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Intended primarily for internal use in client packages that provide
high-level wrappers for users. It is a drop-in substitute for
<code><a href='request_make.html'>request_make()</a></code> that also has the ability to retry the request.</p>
    </div>

    <pre class="usage"><span class='fu'>request_retry</span><span class='op'>(</span><span class='va'>...</span>, max_tries_total <span class='op'>=</span> <span class='fl'>5</span>, max_total_wait_time_in_seconds <span class='op'>=</span> <span class='fl'>100</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>Passed along to <code><a href='request_make.html'>request_make()</a></code>.</p></td>
    </tr>
    <tr>
      <th>max_tries_total</th>
      <td><p>Maximum number of tries.</p></td>
    </tr>
    <tr>
      <th>max_total_wait_time_in_seconds</th>
      <td><p>Total seconds we are willing to
dedicate to waiting, summed across all tries. This is a technical upper
bound and actual cumulative waiting will be less.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>Object of class <code>response</code> from httr.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Consider an example where we are willing to make a request up to 5 times.</p><pre>try  1  2    3        4                5
     |--|----|--------|----------------|
wait  1   2      3           4
</pre>

<p>There will be up to 5 - 1 = 4 waits and we generally want the waiting period
to get longer, in an exponential way. Such schemes are called exponential
backoff. <code>request_retry()</code> implements exponential backoff with "full jitter",
where each waiting time is generated from a uniform distribution, where the
interval of support grows exponentially. A common alternative is "equal
jitter", which adds some noise to fixed, exponentially increasing waiting
times.</p>
<p>Either way our waiting times are based on a geometric series, which, by
convention, is usually written in terms of powers of 2:</p><pre>b , 2b, 4b, 8b, ...
  = b * 2^0, b * 2^1, b * 2^2, b * 2^3, ...
</pre>

<p>The terms in this series require knowledge of <code>b</code>, the so-called exponential
base, and many retry functions and libraries require the user to specify
this. But most users find it easier to declare the total amount of waiting
time they can tolerate for one request. Therefore <code>request_retry()</code> asks for
that instead and solves for <code>b</code> internally. This is inspired by the Opnieuw
Python library for retries. Opnieuw's interface is designed to eliminate
uncertainty around:</p><ul>
<li><p>Units: Is this thing given in seconds? minutes? milliseconds?</p></li>
<li><p>Ambiguity around how things are counted: Are we starting at 0 or 1?
Are we counting tries or just the retries?</p></li>
<li><p>Non-intuitive required inputs, e.g., the exponential base.</p></li>
</ul>

<p>Let <em>n</em> be the total number of tries we're willing to make (the argument
<code>max_tries_total</code>) and let <em>W</em> be the total amount of seconds we're willing
to dedicate to making and retrying this request (the argument
<code>max_total_wait_time_in_seconds</code>). Here's how we determine <em>b</em>:</p><pre>sum_{i=0}^(n - 1) b * 2^i = W
b * sum_{i=0}^(n - 1) 2^i = W
       b * ( (2 ^ n) - 1) = W
                        b = W / ( (2 ^ n) - 1)
</pre>

    <h2 class="hasAnchor" id="special-cases"><a class="anchor" href="#special-cases"></a>Special cases</h2>

    

<p><code>request_retry()</code> departs from exponential backoff in three special cases:</p><ul>
<li><p>It actually implements <em>truncated</em> exponential backoff. There is a floor
and a ceiling on random wait times.</p></li>
<li><p><code>Retry-After</code> header: If the response has a header named <code>Retry-After</code>
(case-insensitive), it is assumed to provide a non-negative integer
indicating the number of seconds to wait. If present, we wait this many
seconds and do not generate a random waiting time. (In theory, this header
can alternatively provide a datetime after which to retry, but we have no
first-hand experience with this variant for a Google API.)</p></li>
<li><p>Sheets API quota exhaustion: In the course of googlesheets4 development,
we've grown very familiar with the <code>429 RESOURCE_EXHAUSTED</code> error. The
Sheets API v4 has "a limit of 500 requests per 100 seconds per project and
100 requests per 100 seconds per user. Limits for reads and writes are
tracked separately." In our experience, the "100 (read or write) requests
per 100 seconds per user" limit is the one you hit most often. If we detect
this specific failure, the first wait time is a bit more than 100 seconds,
then we revert to exponential backoff.</p></li>
</ul>

    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'>
<ul>
<li><p><a href='https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/'>https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/</a></p></li>
<li><p><a href='https://tech.channable.com/posts/2020-02-05-opnieuw.html'>https://tech.channable.com/posts/2020-02-05-opnieuw.html</a></p></li>
<li><p><a href='https://github.com/channable/opnieuw'>https://github.com/channable/opnieuw</a></p></li>
<li><p><a href='https://cloud.google.com/storage/docs/retry-strategy'>https://cloud.google.com/storage/docs/retry-strategy</a></p></li>
<li><p><a href='https://tools.ietf.org/html/rfc7231#section-7.1.3'>https://tools.ietf.org/html/rfc7231#section-7.1.3</a></p></li>
<li><p><a href='https://developers.google.com/sheets/api/reference/limits'>https://developers.google.com/sheets/api/reference/limits</a></p></li>
<li><p><a href='https://googleapis.dev/python/google-api-core/latest/retry.html'>https://googleapis.dev/python/google-api-core/latest/retry.html</a></p></li>
</ul>
</div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>
<span class='va'>req</span> <span class='op'>&lt;-</span> <span class='fu'>gargle</span><span class='fu'>::</span><span class='fu'><a href='request_develop.html'>request_build</a></span><span class='op'>(</span>
  method <span class='op'>=</span> <span class='st'>"GET"</span>,
  path <span class='op'>=</span> <span class='st'>"path/to/the/resource"</span>,
  token <span class='op'>=</span> <span class='st'>"PRETEND_I_AM_TOKEN"</span>
<span class='op'>)</span>
<span class='fu'>gargle</span><span class='fu'>::</span><span class='fu'>request_retry</span><span class='op'>(</span><span class='va'>req</span><span class='op'>)</span>
<span class='op'>}</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='https://jennybryan.org'>Jennifer Bryan</a>, Craig Citro, <a href='http://hadley.nz'>Hadley Wickham</a>, <a href='https://www.rstudio.com'><img src='https://www.tidyverse.org/rstudio-logo.svg' alt='RStudio' height='24' /></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


