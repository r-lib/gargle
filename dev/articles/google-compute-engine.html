<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Google Compute Engine • gargle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Google Compute Engine">
<meta name="robots" content="noindex">
<script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.5.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a></li>
    <li><a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R from the browser</a></li>
    <li><a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Google Compute Engine</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/main/vignettes/articles/google-compute-engine.Rmd" class="external-link"><code>vignettes/articles/google-compute-engine.Rmd</code></a></small>
      <div class="d-none name"><code>google-compute-engine.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gargle.r-lib.org">gargle</a></span><span class="op">)</span></span></code></pre></div>
<p>This article has two purposes:</p>
<ul>
<li>Document how I create VMs on GCE when I work on
<code><a href="../reference/credentials_gce.html">credentials_gce()</a></code>.</li>
<li>Document how instance scopes relate to GCE access token scopes, in
my hands.</li>
</ul>
<div class="section level2">
<h2 id="preparation">Preparation<a class="anchor" aria-label="anchor" href="#preparation"></a>
</h2>
<p>I use the <a href="https://cloudyr.github.io/googleComputeEngineR/" class="external-link">googleComputeEngineR
package</a> to work with GCE VMs.</p>
<p>I have done the required setup for this package:</p>
<ul>
<li><p>Identify (or get) a Google Cloud Platform (GCP) project, with
billing enabled.</p></li>
<li><p>Download the JSON for the default service account for said GCP
project.</p></li>
<li>
<p>Configure env vars in <code>.Renviron</code>:</p>
<pre><code><span><span class="va">GCE_AUTH_FILE</span><span class="op">=</span><span class="st">"/path/to/that/json/mentioned/above.json"</span></span>
<span><span class="va">GCE_DEFAULT_PROJECT_ID</span><span class="op">=</span><span class="st">"gargle-gce"</span></span>
<span><span class="va">GCE_DEFAULT_ZONE</span><span class="op">=</span><span class="st">"us-west1-a"</span></span></code></pre>
</li>
</ul>
<p>Having done this setup, this is how attaching the package looks:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">googleComputeEngineR</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Setting scopes to https://www.googleapis.com/auth/cloud-platform</span></span>
<span><span class="co">#&gt; ✔ Successfully auto-authenticated via /path/to/that/json/mentioned/above.json</span></span>
<span><span class="co">#&gt; Set default project ID to 'gargle-gce'</span></span>
<span><span class="co">#&gt; Set default zone to 'us-west1-a'</span></span></code></pre></div>
<p>Note that (I think) the scopes mentioned above are about
googleComputeEngineR’s activities. I don’t think this has any direct
connection to instance scopes for VMs created by googleComputeEngineR.
(Although, of course,
<code>"https://www.googleapis.com/auth/cloud-platform"</code> is the
default, recommended scope for both contexts.)</p>
<p>You can see your current instances with
<code>gce_list_instances()</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gce_list_instances</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ==Google Compute Engine Instance List==</span></span>
<span><span class="co">#&gt;                        name   machineType     status       zone     externalIP   creationTimestamp</span></span>
<span><span class="co">#&gt; 1 gargle-gce-rstudio-server e2-standard-4 TERMINATED us-west1-a No external IP 2022-10-21 14:41:46</span></span>
<span><span class="co">#&gt; 2           majestic-cuckoo e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-11 18:56:14</span></span>
<span><span class="co">#&gt; 3            piggish-salmon e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-12 07:22:26</span></span>
<span><span class="co">#&gt; 4                tricky-fox e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-12 12:00:52</span></span></code></pre></div>
<p>The above reflects how things look after I’ve been mucking around a
bit and have several VMs that are currently stopped.</p>
</div>
<div class="section level2">
<h2 id="creating-a-vm-on-gce">Creating a VM on GCE<a class="anchor" aria-label="anchor" href="#creating-a-vm-on-gce"></a>
</h2>
<p>Here’s my basic way of creating a VM:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vm</span> <span class="op">&lt;-</span> <span class="fu">gce_vm</span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="st">"rstudio"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"cerebral-lion"</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"jenny"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"jenny1234"</span>,</span>
<span>  predefined_type <span class="op">=</span> <span class="st">"e2-standard-4"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>I can no longer remember why I settled on
<code>predefined_type = "e2-standard-4"</code>.</p>
<p>Here’s what you’ll see:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#&gt; ── ## VM Template: ' rstudio' running at http://{IP_ADDRESS} ─────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; ℹ 2023-04-13 12:03:05 &gt; On first boot, wait a few minutes for docker container to install before logging in.</span></span>
<span><span class="co">#&gt; ==Google Compute Engine Instance==</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Name:                cerebral-lion</span></span>
<span><span class="co">#&gt; Created:             2023-04-13 12:02:44</span></span>
<span><span class="co">#&gt; Machine Type:        e2-standard-4</span></span>
<span><span class="co">#&gt; Status:              RUNNING</span></span>
<span><span class="co">#&gt; Zone:                us-west1-a</span></span>
<span><span class="co">#&gt; External IP:         {IP_ADDRESS}</span></span>
<span><span class="co">#&gt; Disks: </span></span>
<span><span class="co">#&gt;                deviceName       type       mode boot autoDelete</span></span>
<span><span class="co">#&gt; 1 cerebral-lion-boot-disk PERSISTENT READ_WRITE TRUE       TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Metadata:  </span></span>
<span><span class="co">#&gt;                      key            value</span></span>
<span><span class="co">#&gt; 2               template          rstudio</span></span>
<span><span class="co">#&gt; 3 google-logging-enabled             true</span></span>
<span><span class="co">#&gt; 4           rstudio_user            jenny</span></span>
<span><span class="co">#&gt; 5             rstudio_pw        jenny1234</span></span>
<span><span class="co">#&gt; 6      gcer_docker_image rocker/tidyverse</span></span></code></pre></div>
<p>You can then log in to RStudio Server at the given
<code>{IP_ADDRESS}</code>. Helpful snippets for getting that on the
clipboard:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if you, e.g., just created `vm`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"http://"</span>, <span class="fu">gce_get_external_ip</span><span class="op">(</span><span class="va">vm</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">clipr</span><span class="fu">::</span><span class="fu">write_clip</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># if you want to refer to the instance by name</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"http://"</span>, <span class="fu">gce_get_external_ip</span><span class="op">(</span><span class="st">"cerebral-lion"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">clipr</span><span class="fu">::</span><span class="fu">write_clip</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Under the hood, googleComputeEngineR is inserting its own default
choices for the associated service account and scopes. It’s actually as
if you had done:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gce_vm</span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  serviceAccounts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    email <span class="op">=</span> <span class="st">"{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}"</span>,</span>
<span>    scopes <span class="op">=</span> <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Below we will create another VM and pass <code>serviceAccounts</code>
explicitly, so we can also specify the scopes.</p>
<p>To learn more: <a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances" class="external-link uri">https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances</a>.</p>
</div>
<div class="section level2">
<h2 id="do-some-work-in-the-vm">Do some work in the VM<a class="anchor" aria-label="anchor" href="#do-some-work-in-the-vm"></a>
</h2>
<p>Log in to RStudio Server in the VM (see above for getting the IP
address). First, for my current exploration, I want to install gargle
from a specific branch:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"pak"</span><span class="op">)</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"r-lib/gargle@gce-improvements"</span><span class="op">)</span></span></code></pre></div>
<p>Now attach gargle and set verbosity level to
<code>"debug"</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gargle.r-lib.org">gargle</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/gargle_options.html">local_gargle_verbosity</a></span><span class="op">(</span><span class="st">"debug"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s look at the service accounts available to this running
instance:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gce_instance_service_accounts.html">gce_instance_service_accounts</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                     name                                  email aliases</span></span>
<span><span class="co">#&gt; 1 {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} default</span></span>
<span><span class="co">#&gt; 2                                default {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} default</span></span>
<span><span class="co">#&gt;                                           scopes</span></span>
<span><span class="co">#&gt; 1 https://www.googleapis.com/auth/cloud-platform</span></span>
<span><span class="co">#&gt; 2 https://www.googleapis.com/auth/cloud-platform</span></span></code></pre></div>
<blockquote>
<p>You can enable multiple virtual machine instances to use the same
service account, <strong>but a virtual machine instance can only have
one service account identity</strong>.</p>
</blockquote>
<p>So there will only ever be 1 actual service account identify, but you
might see two rows here, as we do above, because the default service
account can be referred to by 2 names: its email and as
<code>default</code>.</p>
<p>Let’s get a token with <code><a href="../reference/token_fetch.html">token_fetch()</a></code> and inspect it.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/token_fetch.html">token_fetch</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; trying `token_fetch()`</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; Trying `credentials_gce()` ...</span></span>
<span><span class="co">#&gt; GceToken initialize</span></span>
<span><span class="co">#&gt; GceToken init_credentials</span></span>
<span><span class="co">#&gt; GCE service account email: '{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}'</span></span>
<span><span class="co">#&gt; GCE service account name: "default"</span></span>
<span><span class="co">#&gt; GCE access token scopes: "...cloud-platform"</span></span>
<span><span class="va">t</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── &lt;GceToken (via gargle)&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;      scopes: ...cloud-platform</span></span>
<span><span class="co">#&gt; credentials: access_token, expires_in, token_type</span></span></code></pre></div>
<p>By default, <code><a href="../reference/credentials_gce.html">credentials_gce()</a></code> uses the
<code>default</code> service account and the
<code>"cloud-platform"</code> scope.</p>
<p>What if we want to do something with the Google Drive API and we
request that scope?</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/token_fetch.html">token_fetch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>,</span>
<span>  <span class="st">"https://www.googleapis.com/auth/drive"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; trying `token_fetch()`</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; Trying `credentials_gce()` ...</span></span>
<span><span class="co">#&gt; ! This requested scope is not among the scopes for the "default" service account:</span></span>
<span><span class="co">#&gt; ✖ https://www.googleapis.com/auth/drive</span></span>
<span><span class="co">#&gt; ℹ If there are problems downstream, this might be the root cause.</span></span>
<span><span class="co">#&gt; GceToken initialize</span></span>
<span><span class="co">#&gt; GceToken init_credentials</span></span>
<span><span class="co">#&gt; ! This requested scope is not among the scopes for the access token returned by the metadata server:</span></span>
<span><span class="co">#&gt; ✖ https://www.googleapis.com/auth/drive</span></span>
<span><span class="co">#&gt; ℹ If there are problems downstream, this might be the root cause.</span></span>
<span><span class="co">#&gt; ! Updating token scopes to reflect its actual scopes:</span></span>
<span><span class="co">#&gt; • https://www.googleapis.com/auth/cloud-platform</span></span>
<span><span class="co">#&gt; GCE service account email: '{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}'</span></span>
<span><span class="co">#&gt; GCE service account name: "default"</span></span>
<span><span class="co">#&gt; GCE access token scopes: "...cloud-platform"</span></span>
<span><span class="va">t</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── &lt;GceToken (via gargle)&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;      scopes: ...cloud-platform</span></span>
<span><span class="co">#&gt; credentials: access_token, expires_in, token_type</span></span></code></pre></div>
<p>We get a token, but still with only the <code>"cloud-platform"</code>
scope, because the Drive scope was not specified when this VM was
created:</p>
<blockquote>
<p>You can use the access token only for scopes that you specified when
you created the instance. For example, if the instance has been granted
only the <code>https://www.googleapis.com/auth/storage-full</code> scope
for Cloud Storage, then it can’t use the access token to make a request
to BigQuery.</p>
</blockquote>
<p>And, indeed, this lack of an explicit Drive scope means that, e.g.,
the googledrive package can’t do operations that require auth:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span><span class="fu">drive_find</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; attempt to access internal gargle data from: googledrive</span></span>
<span><span class="co">#&gt; Error in `gargle::response_process()`:</span></span>
<span><span class="co">#&gt; ! Client error: (403) Forbidden</span></span>
<span><span class="co">#&gt; Request had insufficient authentication scopes.</span></span>
<span><span class="co">#&gt; PERMISSION_DENIED</span></span>
<span><span class="co">#&gt; • message: Insufficient Permission</span></span>
<span><span class="co">#&gt; • domain: global</span></span>
<span><span class="co">#&gt; • reason: insufficientPermissions</span></span>
<span><span class="co">#&gt; Backtrace:</span></span>
<span><span class="co">#&gt;     ▆</span></span>
<span><span class="co">#&gt;  1. └─googledrive::drive_find()</span></span>
<span><span class="co">#&gt;  2.   └─googledrive::do_paginated_request(request, n_max = n_max, n = function(x) length(x$files))</span></span>
<span><span class="co">#&gt;  3.     └─gargle::response_process(page)</span></span>
<span><span class="co">#&gt;  4.       └─gargle:::gargle_abort_request_failed(error_message(resp), resp)</span></span>
<span><span class="co">#&gt;  5.         └─gargle:::gargle_abort(...)</span></span>
<span><span class="co">#&gt;  6.           └─cli::cli_abort(...)</span></span>
<span><span class="co">#&gt;  7.             └─rlang::abort(...)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="suspend-resume-or-stop-the-vm">Suspend, resume, or stop the VM<a class="anchor" aria-label="anchor" href="#suspend-resume-or-stop-the-vm"></a>
</h2>
<p>If you’re not actively working on the VM, you should at least suspend
it. Then you could resume it to pick up where you left off. To ensure
that you aren’t incurring any charges, you should stop the machine, but
then you’ll have to start over if you’ve, e.g., installed dev packages
or downloaded/created any files.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gce_vm_suspend</span><span class="op">(</span><span class="st">"cerebral-lion"</span><span class="op">)</span></span>
<span><span class="fu">gce_vm_resume</span><span class="op">(</span><span class="st">"cerebral-lion"</span><span class="op">)</span></span>
<span><span class="fu">gce_vm_stop</span><span class="op">(</span><span class="st">"cerebral-lion"</span><span class="op">)</span></span></code></pre></div>
<p>It’s a good idea to check that you’ve done whatever you intended with
the instance. Check its status here:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gce_list_instances</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; ==Google Compute Engine Instance List==</span></span>
<span><span class="co">#&gt;                        name   machineType     status       zone     externalIP   creationTimestamp</span></span>
<span><span class="co">#&gt; 1             cerebral-lion e2-standard-4  SUSPENDED us-west1-a No external IP 2023-04-13 12:02:44</span></span>
<span><span class="co">#&gt; 2 gargle-gce-rstudio-server e2-standard-4 TERMINATED us-west1-a No external IP 2022-10-21 14:41:46</span></span>
<span><span class="co">#&gt; 3           majestic-cuckoo e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-11 18:56:14</span></span>
<span><span class="co">#&gt; 4            piggish-salmon e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-12 07:22:26</span></span>
<span><span class="co">#&gt; 5                tricky-fox e2-standard-4 TERMINATED us-west1-a No external IP 2023-04-12 12:00:52</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-vm-and-specifying-scopes">Creating a VM and specifying scopes<a class="anchor" aria-label="anchor" href="#creating-a-vm-and-specifying-scopes"></a>
</h2>
<p>Now we’re going to specifically request Drive scope for a VM. AFAICT
googleComputeEngineR only helps you set scopes at the time of VM
creation, so I’m going to create a new instance. It seems possible to
change scopes for pre-existing instance as long as it is stopped, so
maybe that could be a feature request for googleComputeEngineR (or maybe
I’m overlooking that there’s already a way to do this). Further reading:
<a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#changeserviceaccountandscopes" class="external-link uri">https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#changeserviceaccountandscopes</a>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vm</span> <span class="op">&lt;-</span> <span class="fu">gce_vm</span><span class="op">(</span></span>
<span>  template <span class="op">=</span> <span class="st">"rstudio"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"trustful-bull"</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"jenny"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"jenny1234"</span>,</span>
<span>  predefined_type <span class="op">=</span> <span class="st">"e2-standard-4"</span>,</span>
<span>  serviceAccounts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      email <span class="op">=</span> <span class="st">"{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}"</span>,</span>
<span>      scopes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>,</span>
<span>        <span class="st">"https://www.googleapis.com/auth/drive"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>I get the IP address, log in to RStudio Server, and install the
desired version of gargle (not shown).
<code><a href="../reference/gce_instance_service_accounts.html">gce_instance_service_accounts()</a></code> shows that we have, in
fact, managed to change the <code>scopes</code> available to the default
service account:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gce_instance_service_accounts.html">gce_instance_service_accounts</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                     name                                  email aliases</span></span>
<span><span class="co">#&gt; 1 {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} default</span></span>
<span><span class="co">#&gt; 2                                default {EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT} default</span></span>
<span><span class="co">#&gt;                                                                                 scopes</span></span>
<span><span class="co">#&gt; 1 https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/drive</span></span>
<span><span class="co">#&gt; 2 https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/drive</span></span></code></pre></div>
<p>We see this in actual tokens as well. Note that we get
<code>"drive"</code> scope <em>even if we don’t ask for it</em>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/token_fetch.html">token_fetch</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; trying `token_fetch()`</span></span>
<span><span class="co">#&gt; ...</span></span>
<span><span class="co">#&gt; Trying `credentials_gce()` ...</span></span>
<span><span class="co">#&gt; GceToken initialize</span></span>
<span><span class="co">#&gt; GceToken init_credentials</span></span>
<span><span class="co">#&gt; ! Updating token scopes to reflect its actual scopes:</span></span>
<span><span class="co">#&gt; • https://www.googleapis.com/auth/cloud-platform</span></span>
<span><span class="co">#&gt; • https://www.googleapis.com/auth/drive</span></span>
<span><span class="co">#&gt; GCE service account email: '{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}'</span></span>
<span><span class="co">#&gt; GCE service account name: "default"</span></span>
<span><span class="co">#&gt; GCE access token scopes: "...cloud-platform, ...drive"</span></span>
<span><span class="va">t</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── &lt;GceToken (via gargle)&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;      scopes: ...cloud-platform, ...drive</span></span>
<span><span class="co">#&gt; credentials: access_token, expires_in, token_type</span></span></code></pre></div>
<p>And, as one would expect, it’s now possible to work with the
googledrive package.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span><span class="fu">drive_find</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A dribble: 0 × 3</span></span>
<span><span class="co">#&gt; # ℹ 3 variables: name &lt;chr&gt;, id &lt;drv_id&gt;, drive_resource &lt;list&gt;</span></span>
<span></span>
<span><span class="fu">drive_user</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Logged in as:</span></span>
<span><span class="co">#&gt; • displayName: '{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}'</span></span>
<span><span class="co">#&gt; • emailAddress: '{EMAIL_OF_THE_DEFAULT_SERVICE_ACCOUNT}'</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
