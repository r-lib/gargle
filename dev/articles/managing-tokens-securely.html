<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Managing tokens securely • gargle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Managing tokens securely">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.6.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a></li>
    <li><a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R from the browser</a></li>
    <li><a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Managing tokens securely</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/main/vignettes/articles/managing-tokens-securely.Rmd" class="external-link"><code>vignettes/articles/managing-tokens-securely.Rmd</code></a></small>
      <div class="d-none name"><code>managing-tokens-securely.Rmd</code></div>
    </div>

    
    
<p>It can be tricky to deal with auth in a non-interactive setting on a
remote machine. Specifically, we’re thinking about running tests on a
continuous integration (CI) service, such as GitHub Actions, or
deploying a data product, such as a Shiny app.</p>
<p>This article documents a token management approach for packages and
apps that use gargle, which includes packages like googledrive,
googlesheets4, bigrquery, and gmailr. We want it to be relatively easy
to have a secret, such as a service account token, that we can:</p>
<ul>
<li>Use locally.</li>
<li>Use with CI services, such as GitHub Actions.</li>
<li>Use with <a href="https://docs.r-hub.io" class="external-link">R-hub</a>.</li>
<li>Use in deployed settings, such as <a href="https://posit.co/products/enterprise/connect/" class="external-link">Posit
Connect</a>.</li>
</ul>
<p>all while keeping the secret secure.</p>
<p>The approach uses symmetric encryption, where the shared key is
stored in an environment variable. Why? This works well with existing
conventions for local R usage. Most CI or hosting services offer support
for secure environment variables. And R-hub accepts environment
variables via the <code>env_vars</code> argument of <a href="https://r-hub.github.io/rhub/reference/check.html" class="external-link"><code>rhub::check()</code></a>.</p>
<p>This mostly uses functions inlined from the httr2 (<a href="https://httr2.r-lib.org/" class="external-link uri">https://httr2.r-lib.org/</a>) package, which gargle does not
(yet) depend on.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gargle.r-lib.org">gargle</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview-of-the-approach">Overview of the approach<a class="anchor" aria-label="anchor" href="#overview-of-the-approach"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Generate an encryption key (basically a password) and give it a
self-documenting name, e.g. <code>GARGLE_KEY</code>. Store as an
environment variable.</li>
<li>Identify a secret file of interest, such as the JSON representing a
service account token. This is presumably stored <em>outside</em> your
package.</li>
<li>Use the key to apply a method for symmetric encryption to the target
file. Store the resulting encrypted file in a designated location
<em>within</em> your package.</li>
<li>Store or pass the key as an environment variable everywhere you’ll
need to decrypt the secret.
<ul>
<li>Check that the platform has support for keeping the key
concealed.</li>
<li>Make sure you don’t do anything in your own code that would dump it
to a log file, such as printing all environment variables.</li>
</ul>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="annotated-code-through">Annotated code-through<a class="anchor" aria-label="anchor" href="#annotated-code-through"></a>
</h2>
<div class="section level3">
<h3 id="choose-a-name-for-the-encryption-key">Choose a name for the encryption key<a class="anchor" aria-label="anchor" href="#choose-a-name-for-the-encryption-key"></a>
</h3>
<p>Pick a name for the encryption key. I recommend that it be clearly
associated with whatever package or data product you plan to use it
with. For example, gargle’s testing credentials are encrypted with a key
named <code>GARGLE_KEY</code>.</p>
<p>You don’t need to store this name as a variable. We’re only doing so
because it makes this exposition easier.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key_name</span> <span class="op">&lt;-</span> <span class="st">"SOMETHING_KEY"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-the-encryption-key">Generate the encryption key<a class="anchor" aria-label="anchor" href="#generate-the-encryption-key"></a>
</h3>
<p>In real life, you should keep the output of
<code><a href="../reference/gargle_secret.html">secret_make_key()</a></code> to yourself! We reveal it here as part of
the exposition.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gargle_secret.html">secret_make_key</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">key</span></span>
<span><span class="co">#&gt; [1] "F99_lVi7Z8FOFGI5L48UYA"</span></span></code></pre></div>
<p><code><a href="../reference/gargle_secret.html">gargle::secret_make_key()</a></code> is a copy of
<code><a href="https://httr2.r-lib.org/reference/secrets.html" class="external-link">httr2::secret_make_key()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="define-environment-variable-in-local--renviron">Define environment variable in local <code>.Renviron</code><a class="anchor" aria-label="anchor" href="#define-environment-variable-in-local--renviron"></a>
</h3>
<p>Combine the key name and value to form a line like this in your
user-level <code>.Renviron</code> file:</p>
<pre><code><span><span class="va">SOMETHING_KEY</span><span class="op">=</span><span class="va">F99_lVi7Z8FOFGI5L48UYA</span></span></code></pre>
<p><code>usethis::edit_r_environ()</code> can help create or open this
file. I <strong>strongly recommend</strong> using the user-level
<code>.Renviron</code>, as opposed to project-level, because this makes
it less likely you will share sensitive information by mistake. If for
some reason you choose to store the key in a file inside a Git repo, you
must make sure that file is listed in <code>.gitignore</code>. This
still would not prevent leaking your secret if, for example, that
project is in a directory that syncs to DropBox or Google Drive
(i.e. any service that has no real notion of an “ignore” file).</p>
<p>Remember you’ll need to restart R (or call
<code>readRenviron("~/.Renviron")</code>) for the newly defined
environment variable to take effect.</p>
<p>In an interactive session, you can call <code><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv()</a></code> to
do a quick check that the key is setup correctly locally:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SOMETHING_KEY"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "F99_lVi7Z8FOFGI5L48UYA"</span></span></code></pre></div>
<p>This <code><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv()</a></code> call is <strong>exactly</strong> the
sort of thing you should be very careful about doing in a deployed
setting, where the result could up in a (semi-)public log file.</p>
</div>
<div class="section level3">
<h3 id="encrypt-credentials">Encrypt credentials<a class="anchor" aria-label="anchor" href="#encrypt-credentials"></a>
</h3>
<p>The Google auth ecosystem involves different types of secrets, which
require slightly different handling when you’re placing an encrypted
version inside your project.</p>
<div class="section level4">
<h4 id="encrypt-a-json-file">Encrypt a JSON file<a class="anchor" aria-label="anchor" href="#encrypt-a-json-file"></a>
</h4>
<p><code><a href="../reference/gargle_secret.html">secret_encrypt_json()</a></code> is a gargle-specific function,
built on top of httr2’s secret management machinery. This is because
JSON files and strings are especially relevant to auth in the Google
ecosystem. You will be interested in <code><a href="../reference/gargle_secret.html">secret_encrypt_json()</a></code>
if you want to encrypt a service account key (or, even, an OAuth
client).</p>
<p><code><a href="../reference/gargle_secret.html">secret_encrypt_json()</a></code> takes 3 arguments:</p>
<ul>
<li>
<code>json</code>: probably the path to a JSON file, but a JSON
string is also acceptable.</li>
<li>
<code>path</code>: The path to write the encrypted JSON to.
Technically this is optional, but this function mostly exists to write
to file.</li>
<li>
<code>key</code>: The name of the environment variable that holds
the encryption key.</li>
</ul>
<p>This example shows how googledrive’s testing credentials are placed
inside the package source. <code>googledrive-testing.json</code> is a
JSON file downloaded for a service account managed via the <a href="https://console.cloud.google.com/project" class="external-link">Google API / Cloud
Platform console</a>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gargle_secret.html">secret_encrypt_json</a></span><span class="op">(</span></span>
<span>  json <span class="op">=</span> <span class="st">"~/some/place/where/I/keep/secret/stuff/googledrive-testing.json"</span>,</span>
<span>  path <span class="op">=</span> <span class="st">"inst/secret/googledrive-testing.json"</span>,</span>
<span>  key <span class="op">=</span> <span class="st">"GOOGLEDRIVE_KEY"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This writes an encrypted version of
<code>googledrive-testing.json</code> to
<code>inst/secret/googledrive-testing.json</code> relative to the
current working directory, which is presumably the top-level directory
of googledrive’s source. This encrypted file <em>should</em> be
committed and pushed.</p>
<p>Later we show how to use <code>secret_decypt_json()</code> to decrypt
this token.</p>
</div>
<div class="section level4">
<h4 id="encrypt-an-r-object">Encrypt an R object<a class="anchor" aria-label="anchor" href="#encrypt-an-r-object"></a>
</h4>
<p><code><a href="../reference/gargle_secret.html">gargle::secret_write_rds()</a></code> is a copy of
<code><a href="https://httr2.r-lib.org/reference/secrets.html" class="external-link">httr2::secret_write_rds()</a></code>, exported by gargle for
convenience. If you must encrypt an R object, such as a
<code>Gargle2.0</code> user token, this is the function you need. But
note that it should be quite rare to encrypt a user token. If at all
possible, use a service account instead.</p>
<p><code><a href="../reference/gargle_secret.html">secret_write_rds()</a></code> takes 3 arguments:</p>
<ul>
<li>
<code>x</code>: The R object to encrypt. In the gargle context, this
is usually a token. After a successful OAuth dance, wrapper packages
often provide access to the token with a function like
<code>googledrive::drive_token()</code>,
<code>googlesheets4::gs4_token()</code>,
<code>bigrquery::bq_token()</code>, or
<code>gmailr::gm_token()</code>.</li>
<li>
<code>path</code>: The path to write the encrypted object to.
Technically this is optional, but this function mostly exists to write
to file.</li>
<li>
<code>key</code>: The name of the environment variable that holds
the encryption key.</li>
</ul>
<p>This example shows how an encrypted googlesheets4 user token could be
placed inside the <code>.secrets/</code> directory of a project, e.g. a
Shiny app intended for deployment.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">".secrets"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get a token and DO NOT CACHE IT</span></span>
<span><span class="fu">gs4_auth</span><span class="op">(</span><span class="st">"someone@example.com"</span>, cache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># encrypt the token and write to file</span></span>
<span><span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_secret.html">secret_write_rds</a></span><span class="op">(</span></span>
<span>  <span class="fu">gs4_token</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="st">".secrets/gs4-token.rds"</span>,</span>
<span>  key <span class="op">=</span> <span class="st">"SOMETHING_KEY"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This writes an encrypted version of the token to
<code>.secrets/gs4-token.rds</code>. This encrypted file <em>should</em>
be committed and pushed/deployed.</p>
<p>Later we show how to use <code><a href="../reference/gargle_secret.html">gargle::secret_read_rds()</a></code> to
decrypt this token.</p>
</div>
</div>
<div class="section level3">
<h3 id="provide-environment-variable-to-other-services">Provide environment variable to other services<a class="anchor" aria-label="anchor" href="#provide-environment-variable-to-other-services"></a>
</h3>
<p>Here’s how you make the encryption key available when your code is
running elsewhere.</p>
<div class="section level4">
<h4 id="github-actions">GitHub Actions:<a class="anchor" aria-label="anchor" href="#github-actions"></a>
</h4>
<p>Define the environment variable as an encrypted secret in your
repo:</p>
<p><a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets" class="external-link uri">https://docs.github.com/en/actions/security-guides/encrypted-secrets</a></p>
<p>Use the secrets context to expose a secret as an environment variable
in your workflows. That will look like like so, in some appropriate
place in your workflow file:</p>
<pre><code>env:
  SOMETHING_KEY: ${{ secrets.SOMETHING_KEY }}</code></pre>
<p>The secret, and therefore the associated environment variable, is not
available when workflows are triggered via an external pull request.</p>
</div>
<div class="section level4">
<h4 id="r-hub">R-hub<a class="anchor" aria-label="anchor" href="#r-hub"></a>
</h4>
<p>Send the environment variable in your calls to <a href="https://r-hub.github.io/rhub/reference/check.html" class="external-link"><code>rhub::check()</code></a>
and <a href="https://r-hub.github.io/rhub/reference/index.html#section-check-shortcuts" class="external-link">friends</a>:</p>
<pre><code><span><span class="fu">rhub</span><span class="fu">::</span><span class="fu">check</span><span class="op">(</span>env_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SOMETHING_KEY"</span>, names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="posit-connect">Posit Connect<a class="anchor" aria-label="anchor" href="#posit-connect"></a>
</h4>
<p>Define the environment variable in the <em>{X} Vars</em> pane of the
dashboard for your content:</p>
<p><a href="https://docs.posit.co/connect/user/content-settings/#content-vars" class="external-link uri">https://docs.posit.co/connect/user/content-settings/#content-vars</a></p>
</div>
</div>
<div class="section level3">
<h3 id="using-encrypted-credentials">Using encrypted credentials<a class="anchor" aria-label="anchor" href="#using-encrypted-credentials"></a>
</h3>
<p>It should come as no surprise that <code><a href="../reference/gargle_secret.html">secret_encrypt_json()</a></code>
and <code><a href="../reference/gargle_secret.html">secret_write_rds()</a></code> each have a companion function for
decryption: <code><a href="../reference/gargle_secret.html">secret_decrypt_json()</a></code> and
<code><a href="../reference/gargle_secret.html">secret_read_rds()</a></code>, respectively.</p>
<div class="section level4">
<h4 id="decrypt-a-json-file">Decrypt a JSON file<a class="anchor" aria-label="anchor" href="#decrypt-a-json-file"></a>
</h4>
<p>Recall that in the example above we encrypted the JSON specifying a
service account token, for use in CI by googledrive. Here’s how you
would use <code><a href="../reference/gargle_secret.html">secret_decrypt_json()</a></code> to decrypt that token and
direct googledrive to use it:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_secret.html">secret_decrypt_json</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"secret"</span>, <span class="st">"googledrive-testing.json"</span>, package <span class="op">=</span> <span class="st">"googledrive"</span><span class="op">)</span>,</span>
<span>    <span class="st">"GOOGLEDRIVE_KEY"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="decrypt-a-user-token">Decrypt a user token<a class="anchor" aria-label="anchor" href="#decrypt-a-user-token"></a>
</h4>
<p>Recall that in the example above we encrypted a googlesheets4 user
token, for use inside something like a deployed Shiny app. Here’s how
you would use <code><a href="../reference/gargle_secret.html">secret_read_rds()</a></code> to decrypt that token and
direct googlesheets4 to use it:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">gs4_auth</span><span class="op">(</span>token <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_secret.html">secret_read_rds</a></span><span class="op">(</span></span>
<span>  <span class="st">".secrets/gs4-token.rds"</span>,</span>
<span>  key <span class="op">=</span> <span class="st">"SOMETHING_KEY"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="anticipating-decryption-failure">Anticipating decryption failure<a class="anchor" aria-label="anchor" href="#anticipating-decryption-failure"></a>
</h3>
<p>The snippets above are great when they work, i.e. when
<code>"SOMETHING_KEY"</code> is available for decryption. But what about
when the key isn’t available?</p>
<p>You do want to rig things for graceful, informative failure in this
case.</p>
<ul>
<li>If you’re using encrypted testing credentials, CRAN is not going to
be able to decrypt them. So you want affected tests to be
<em>skipped</em> in that case, not to error. Likewise, an external pull
request won’t be able to use the testing credentials, so you also want
test skipping there.</li>
<li>If you’re using encrypted credentials in a Shiny app, you might want
to make some provision for when the encryption key is unavailable. The
person most likely to benefit from this is you, i.e. when you’re trying
to figure out why your app isn’t working. It’s nice to have a clear
signal that the encryption key is unavailable instead of some mysterious
deployment failure.</li>
</ul>
<div class="section level4">
<h4 id="condition-on-key-availability">Condition on key availability<a class="anchor" aria-label="anchor" href="#condition-on-key-availability"></a>
</h4>
<p><code>secret_has_key("SOMETHING_KEY")</code> reports whether the
<code>"SOMETHING_KEY"</code> environment variable is defined. In a
deployed data product, you might want to call
<code><a href="../reference/gargle_secret.html">secret_has_key()</a></code> before any attempt to decrypt a secret. If
the encryption key is not available, report that finding and arrange to
do something graceful instead of erroring, especially in some cryptic,
difficult-to-debug way.</p>
</div>
<div class="section level4">
<h4 id="automatic-skips">Automatic skips<a class="anchor" aria-label="anchor" href="#automatic-skips"></a>
</h4>
<p>The <code>secret_*</code> functions have a built-in feature such
that, if they are called during testing, when the encryption key is
unavailable, that test is skipped. That behaviour is implemented in the
internal helper <code>secret_get_key()</code>, which looks something
like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">secret_get_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">envvar</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="va">envvar</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">key</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">is_testing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">msg</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"Env var {envvar} not defined."</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">skip</a></span><span class="op">(</span><span class="va">msg</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># error</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># return the key</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If <code>envvar</code> (presumably, <code>SOMETHING_KEY</code> or the
like) is undefined, during tests, that test is just skipped. Note that
“during tests” is defined as when <code>is_testing()</code> returns
<code>TRUE</code>. The <code>is_testing()</code> helper is defined like
so:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_testing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"TESTTHAT"</span><span class="op">)</span>, <span class="st">"true"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Therefore automatic skipping will happen during automated testing,
including on CRAN, and for external contributors. The automatic skips
won’t kick in when you’re just, e.g., running a single test “by hand”.
The <code>"TESTTHAT"</code> environment variable is set by functions
like <code>devtools::test()</code> or
<code><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">testthat::test_file()</a></code>.</p>
<p>I will also point out that this is not how test skipping is achieved
in packages like googledrive, googlesheets4, bigrquery, and gmailr.
Those packages are all designed to load a token into an internal auth
state, then use that token in downstream requests. This means that
individual requests or tests won’t ever call
<code><a href="../reference/gargle_secret.html">secret_decrypt_json()</a></code> or <code><a href="../reference/gargle_secret.html">secret_read_rds()</a></code>, so
the automatic skips aren’t relevant. These packages make different
arrangements for skipping auth-requiring tests when the testing
credentials are unavailable. The source code for those packages is the
best place to learn more. Start by consulting the package’s
<code>tests/testthat/helper.R</code> file.</p>
</div>
<div class="section level4">
<h4 id="ci-configuration">CI configuration<a class="anchor" aria-label="anchor" href="#ci-configuration"></a>
</h4>
<p>I recommend that you actively check your package under the “no
decryption, no token” scenario, so that you discover problems before
CRAN or your contributors do. In fact, this should probably be the
default situation for your <code>R CMD check</code> workflow.</p>
<p>In auth-requiring package, we usually have two
<code>R CMD check</code> workflows:</p>
<ul>
<li>
<code>R-CMD-check.yaml</code> is the main workflow, which tests the
package against a relatively large matrix of operating systems and R
versions. This workflow does not have access to the encryption key.</li>
<li>
<code>with-auth.yaml</code> is another <code>R CMD check</code>
workflow that only checks with the released version of R, on
<code>ubuntu-latest</code>. This workflow does have access to the
encryption key. Here’s the bit of the <code>.yaml</code> file where that
happens:</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/check-r-package@v2</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="at">          </span><span class="fu">SOMETHING_KEY</span><span class="kw">:</span><span class="at"> ${{ secrets.SOMETHING_KEY }}</span></span></code></pre></div>
<p>Look at the GitHub Actions workflow configurations for googledrive,
googlesheets4, bigrquery, and gmailr, to see some concrete examples.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="resources">Resources<a class="anchor" aria-label="anchor" href="#resources"></a>
</h2>
<ul>
<li><p>The <a href="https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management" class="external-link">Wrapping
APIs vignette</a> for the httr2 package, specifically the “Secret
management” section.</p></li>
<li><p>The <a href="https://docs.ropensci.org/sodium/articles/crypto101.html#symmetric-encryption" class="external-link">How
does cryptography work? vignette</a> for the sodium package,
specifically the “Symmetric encryption” section.</p></li>
</ul>
<!-- The future gmailr vignette and demos re: encrypted user token. -->
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
