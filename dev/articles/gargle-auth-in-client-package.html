<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gargle">
<title>How to use gargle for auth in a client package • gargle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.2/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.2/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to use gargle for auth in a client package">
<meta property="og:description" content="gargle">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.0.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a>
    <a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a>
    <a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R in the browser</a>
    <a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to use gargle for auth in a client package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/HEAD/vignettes/gargle-auth-in-client-package.Rmd" class="external-link"><code>vignettes/gargle-auth-in-client-package.Rmd</code></a></small>
      <div class="d-none name"><code>gargle-auth-in-client-package.Rmd</code></div>
    </div>

    
    
<p>gargle provides common infrastructure for use with Google APIs. This vignette describes one possible design for using gargle to deal with auth, in a client package that provides a high-level wrapper for a specific API.</p>
<p>There are frequent references to <a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a>, which uses the design described here, along with <a href="https://bigrquery.r-dbi.org" class="external-link">bigrquery</a> (v1.2.0 and higher), <a href="https://gmailr.r-lib.org" class="external-link">gmailr</a> (v1.0.0 and higher), and <a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a> (the successor to <a href="https://github.com/jennybc/googlesheets" class="external-link">googlesheets</a>).</p>
<div class="section level2">
<h2 id="key-choices">Key choices<a class="anchor" aria-label="anchor" href="#key-choices"></a>
</h2>
<p>Getting a token requires several pieces of information and there are stark differences in how much users (need to) know or control about this process. Let’s review them, with an eye towards identifying the responsibilities of the package author versus the user.</p>
<ul>
<li>Overall config: OAuth app and API key. Who provides?</li>
<li>Token-level properties: Google identity (email) and scopes.</li>
<li>Request-level: Who manages tokens and injects them into requests?</li>
</ul>
<div class="section level3">
<h3 id="user-facing-auth">User-facing auth<a class="anchor" aria-label="anchor" href="#user-facing-auth"></a>
</h3>
<p>In googledrive, the main user-facing auth function is <code>googledrive::drive_auth()</code>. Here is its definition (at least approximately, remember this is static code):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># googledrive::</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>drive_auth <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">email =</span> gargle<span class="sc">::</span><span class="fu">gargle_oauth_email</span>(),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">path =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">scopes =</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cache =</span> gargle<span class="sc">::</span><span class="fu">gargle_oauth_cache</span>(),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">use_oob =</span> gargle<span class="sc">::</span><span class="fu">gargle_oob_default</span>(),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">token =</span> <span class="cn">NULL</span>) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  cred <span class="ot">&lt;-</span> gargle<span class="sc">::</span><span class="fu">token_fetch</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">scopes =</span> scopes,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">app =</span> <span class="fu">drive_oauth_app</span>() <span class="sc">%||%</span> <span class="er">&lt;</span>BUILT_IN_DEFAULT_APP<span class="sc">&gt;</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">email =</span> email,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> path,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">package =</span> <span class="st">"googledrive"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">cache =</span> cache,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_oob =</span> use_oob,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">token =</span> token</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(cred, <span class="st">"Token2.0"</span>)) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># throw an informative error here</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  .auth<span class="sc">$</span><span class="fu">set_cred</span>(cred)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  .auth<span class="sc">$</span><span class="fu">set_auth_active</span>(<span class="cn">TRUE</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>drive_auth()</code> is called automatically upon the first need of a token and that can lead to user interaction, but does not necessarily do so. <code><a href="../reference/token_fetch.html">token_fetch()</a></code> is described in the vignette <a href="https://gargle.r-lib.org/articles/how-gargle-gets-tokens.html">How gargle gets tokens</a>. The internal <code>.auth</code> object maintains googledrive’s auth state and is explained next.</p>
</div>
<div class="section level3">
<h3 id="auth-state">Auth state<a class="anchor" aria-label="anchor" href="#auth-state"></a>
</h3>
<p>A client package can use an internal object of class <code>gargle::AuthClass</code> to hold the auth state. Here’s how it is initialized in googledrive:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.auth</span> <span class="op">&lt;-</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/init_AuthState.html">init_AuthState</a></span><span class="op">(</span></span>
<span>  package     <span class="op">=</span> <span class="st">"googledrive"</span>,</span>
<span>  auth_active <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="co"># app = NULL,</span></span>
<span>  <span class="co"># api_key = NULL,</span></span>
<span>  <span class="co"># cred = NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The OAuth <code>app</code> and <code>api_key</code> are configurable by the user and, when <code>NULL</code>, downstream functions can fall back to internal credentials. The <code>cred</code> field is populated by the first call to <code>drive_auth()</code> (direct or indirectly via <code>drive_token()</code>).</p>
</div>
<div class="section level3">
<h3 id="oauth-app">OAuth app<a class="anchor" aria-label="anchor" href="#oauth-app"></a>
</h3>
<p>Most users should present OAuth user credentials to Google APIs. However, most users can also be spared the fiddly details surrounding this. The OAuth app is one example. The app is a component that most users do not even know about and they are content to use the same app for all work through a client package: possibly, the app built into the package.</p>
<p>There is a field in the <code>.auth</code> auth state to hold the OAuth <code>app</code>. Exported auth helpers, <code>drive_oauth_app()</code> and <code>drive_auth_configure()</code>, retrieve and modify the current app to support users ready to take that level of control.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">google_app</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/oauth_app.html" class="external-link">oauth_app</a></span><span class="op">(</span></span>
<span>  appname <span class="op">=</span> <span class="st">"acme-corp"</span>,</span>
<span>  key     <span class="op">=</span> <span class="st">"123456789.apps.googleusercontent.com"</span>,</span>
<span>  secret  <span class="op">=</span> <span class="st">"abcdefghijklmnopqrstuvwxyz"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">drive_auth_configure</span><span class="op">(</span>app <span class="op">=</span> <span class="va">google_app</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_oauth_app</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;oauth_app&gt; acme-corp</span></span>
<span><span class="co">#&gt;   key:    123456789.apps.googleusercontent.com</span></span>
<span><span class="co">#&gt;   secret: &lt;hidden&gt;</span></span></code></pre></div>
<p>Do not “borrow” an OAuth app (OAuth client ID and secret) from gargle or any other package; always use credentials associated with your package or provided by your user. Per the Google User Data Policy <a href="https://developers.google.com/terms/api-services-user-data-policy" class="external-link uri">https://developers.google.com/terms/api-services-user-data-policy</a>, your application must accurately represent itself when authenticating to Google API services.</p>
</div>
<div class="section level3">
<h3 id="api-key">API key<a class="anchor" aria-label="anchor" href="#api-key"></a>
</h3>
<p>Some Google APIs can be used in an unauthenticated state, if and only if requests include an API key. For example, this is a great way to read a Google Sheet that is world-readable or readable by “anyone with a link” from a Shiny app, thereby designing away the need to manage user credentials on the server.</p>
<p>The user can provide their own API key via <code>drive_auth_configure()</code> and retrieve that value with <code>drive_api_key()</code>, just like the OAuth app. The API key is stored in the <code>api_key</code> field of the <code>.auth</code> auth state.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth_configure</span><span class="op">(</span>api_key <span class="op">=</span> <span class="st">"123456789"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_api_key</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; "123456789"</span></span></code></pre></div>
<p>Many users aren’t motivated to take this level of control and appreciate when a package provides a built-in default API key. As with the app, packages should obtain their own API key and not borrow the gargle or tidyverse key.</p>
<p>Some APIs are not usable without a token, in which case a wrapper package may not even expose functionality for managing an API key. Among the packages mentioned as examples, this is true of bigrquery.</p>
</div>
<div class="section level3">
<h3 id="email-or-google-identity">Email or Google identity<a class="anchor" aria-label="anchor" href="#email-or-google-identity"></a>
</h3>
<p>In contrast to the OAuth app and API key, every user must express which identity they wish to present to the API. This is a familiar concept and users expect to specify this. Since users may have more than one Google account, it’s quite likely that they will want to switch between accounts, even within a single R session, or that they might want to explicitly declare the identity to be used in a specific script or app.</p>
<p>That explains why <code>drive_auth()</code> has the optional <code>email</code> argument that lets users proactively specify their identity. <code>drive_auth()</code> is usually called indirectly upon first need, but a user can also call it proactively in order to specify their target <code>email</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># googledrive::</span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>email <span class="op">=</span> <span class="st">"janedoe_work@gmail.com"</span><span class="op">)</span></span></code></pre></div>
<p>If <code>email</code> is not given, gargle also checks for an option named “gargle_oauth_email”. The <code>email</code> is used to look up tokens in the cache and, if no suitable token is found, it is used to pre-configure the OAuth chooser in the browser. Read more in the help for <code><a href="../reference/gargle_options.html">gargle::gargle_oauth_email()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="scopes">Scopes<a class="anchor" aria-label="anchor" href="#scopes"></a>
</h3>
<p>Most users have no concept of scopes. They just know they want to work with, e.g., Google Drive or Google Sheets. A client package can usually pick sensible default scopes, that will support what most users want to do.</p>
<p>Here’s a reminder of the signature of <code>googledrive::drive_auth()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># googledrive::</span></span>
<span><span class="va">drive_auth</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">email</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oauth_email</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">path</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       <span class="va">scopes</span> <span class="op">=</span> <span class="st">"https://www.googleapis.com/auth/drive"</span>,</span>
<span>                       <span class="va">cache</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oauth_cache</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">use_oob</span> <span class="op">=</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="../reference/gargle_options.html">gargle_oob_default</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                       <span class="va">token</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span> <span class="va">...</span> <span class="op">}</span></span></code></pre></div>
<p>googledrive ships with a default scope, but a motivated user could call <code>drive_auth()</code> pre-emptively at the start of the session and request different scopes. For example, if they intend to only read data and want to guard against inadvertent file modification, they might opt for the <code>drive.readonly</code> scope.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># googledrive::</span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>scopes <span class="op">=</span> <span class="st">"https://www.googleapis.com/auth/drive.readonly"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="oauth-cache-and-out-of-bound-auth">OAuth cache and Out-of-bound auth<a class="anchor" aria-label="anchor" href="#oauth-cache-and-out-of-bound-auth"></a>
</h3>
<p>The location of the token cache and whether to prefer out-of-bound auth are two aspects of OAuth where most users are content to go along with sensible default behaviour. For those who want to exert control, that can be done in direct calls to <code>drive_auth()</code> or by configuring an option. Read the help for <code><a href="../reference/gargle_options.html">gargle::gargle_oauth_cache()</a></code> and <code><a href="../reference/gargle_options.html">gargle::gargle_oob_default()</a></code> for more about these options.</p>
</div>
</div>
<div class="section level2">
<h2 id="overview-of-mechanics">Overview of mechanics<a class="anchor" aria-label="anchor" href="#overview-of-mechanics"></a>
</h2>
<p>Here’s a concrete outline of how one could set up a client package to get its auth functionality from gargle.</p>
<ol style="list-style-type: decimal">
<li>Add gargle to your package’s <code>Imports</code>.</li>
<li>Create a file <code>R/YOURPKG_auth.R</code>.</li>
<li>Create an internal <code>gargle::AuthClass</code> object to hold auth state. <code>R/YOURPKG_auth.R</code> is a good place to do this.</li>
<li>Define standard functions for the auth interface between gargle and your package; do this in <code>R/YOURPKG_auth.R</code>. Examples: <a href="https://github.com/tidyverse/googledrive/blob/main/R/drive_auth.R" class="external-link"><code>tidyverse/googledrive/R/drive_auth.R</code></a> and <a href="https://github.com/r-dbi/bigrquery/blob/main/R/bq-auth.R" class="external-link"><code>r-dbi/bigrquery/R/bq_auth.R</code></a>.</li>
<li>Use gargle’s roxygen helpers to create the docs for your auth functions. This relieves you from writing docs and you inherit standard wording. See previously cited examples for inspiration.</li>
<li>Use the functions <code>YOURPKG_token()</code> and <code>YOURPKG_api_key()</code> (defined in the standard auth interface) to insert a token or API key in your package’s requests.</li>
</ol>
</div>
<div class="section level2">
<h2 id="getting-that-first-token">Getting that first token<a class="anchor" aria-label="anchor" href="#getting-that-first-token"></a>
</h2>
<p>I focus on early use, by the naive user, with the OAuth flow. When the user first calls a high-level googledrive function such as <code>drive_find()</code>, a Drive request is ultimately generated with a call to <code>googledrive::request_generate()</code>. Here is its definition, at least approximately:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># googledrive::</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>request_generate <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">endpoint =</span> <span class="fu">character</span>(),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">params =</span> <span class="fu">list</span>(),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">key =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">token =</span> <span class="fu">drive_token</span>()) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  ept <span class="ot">&lt;-</span> .endpoints[[endpoint]]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(ept)) {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop_glue</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Endpoint not recognized:</span><span class="sc">\n</span><span class="st">  * {endpoint}"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## modifications specific to googledrive package</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  params<span class="sc">$</span>key <span class="ot">&lt;-</span> key <span class="sc">%||%</span> params<span class="sc">$</span>key <span class="sc">%||%</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drive_api_key</span>() <span class="sc">%||%</span> <span class="er">&lt;</span>BUILT_IN_DEFAULT_API_KEY<span class="sc">&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ept<span class="sc">$</span>parameters<span class="sc">$</span>supportsTeamDrives)) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    params<span class="sc">$</span>supportsTeamDrives <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  req <span class="ot">&lt;-</span> gargle<span class="sc">::</span><span class="fu">request_develop</span>(<span class="at">endpoint =</span> ept, <span class="at">params =</span> params)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  gargle<span class="sc">::</span><span class="fu">request_build</span>(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> req<span class="sc">$</span>path,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> req<span class="sc">$</span>method,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> req<span class="sc">$</span>params,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">body =</span> req<span class="sc">$</span>body,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">token =</span> token</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>googledrive::request_generate()</code> is a thin wrapper around <code><a href="../reference/request_develop.html">gargle::request_develop()</a></code> and <code><a href="../reference/request_develop.html">gargle::request_build()</a></code> that only implements details specific to googledrive, before delegating to more general functions in gargle. The vignette <a href="https://gargle.r-lib.org/articles/request-helper-functions.html">Request Helper Functions</a> documents these gargle functions.</p>
<p><code>googledrive::request_generate()</code> gets a token with <code>drive_token()</code>, which is defined like so:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># googledrive::</span></span>
<span><span class="va">drive_token</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isFALSE</a></span><span class="op">(</span><span class="va">.auth</span><span class="op">$</span><span class="va">auth_active</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">drive_has_token</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">drive_auth</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/config.html" class="external-link">config</a></span><span class="op">(</span>token <span class="op">=</span> <span class="va">.auth</span><span class="op">$</span><span class="va">cred</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>where <code>drive_has_token()</code> in a helper defined as:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># googledrive::</span></span>
<span><span class="va">drive_has_token</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">.auth</span><span class="op">$</span><span class="va">cred</span>, <span class="st">"Token2.0"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>By default, auth is active, and, for a fresh start, we won’t have a token stashed in <code>.auth</code> yet. So this will result in a call to <code>drive_auth()</code> to obtain a credential, which is then cached in <code>.auth$cred</code> for the remainder of the session. All subsequent calls to <code>drive_token()</code> will just spit back this token.</p>
<p>Above, we discussed scenarios where an advanced user might call <code>drive_auth()</code> proactively, with non-default arguments, possibly even loading a service token or using alternative flows, like Application Default Credentials or a Google Cloud Engine flow. Any token loaded in that way is stashed in <code>.auth$cred</code> and will be returned by subsequent calls to <code>drive_token()</code>.</p>
<p>Multiple gargle-using packages can use a shared token by obtaining a suitably scoped token with one package, then registering that token with the other packages. For example, the default scope requested by googledrive is also sufficient for operations available in googlesheets4. You could use a shared token like so:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>email <span class="op">=</span> <span class="st">"jane_doe@example.com"</span><span class="op">)</span> <span class="co"># gets a suitably scoped token</span></span>
<span>                                           <span class="co"># and stashes for googledrive use</span></span>
<span></span>
<span><span class="fu">gs4_auth</span><span class="op">(</span>token <span class="op">=</span> <span class="fu">drive_token</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>            <span class="co"># registers token with googlesheets4</span></span>
<span></span>
<span><span class="co"># now work with both packages freely ...</span></span></code></pre></div>
<p>It is important to make sure that the token-requesting package (googledrive, above) is using an OAuth app (client ID and secret) for which all the necessary APIs and scopes are enabled.</p>
</div>
<div class="section level2">
<h2 id="auth-interface">Auth interface<a class="anchor" aria-label="anchor" href="#auth-interface"></a>
</h2>
<p>The exported functions like <code>drive_auth()</code>, <code>drive_token()</code>, etc. constitute the auth interface between googledrive and gargle and are centralized in <a href="https://github.com/tidyverse/googledrive/blob/main/R/drive_auth.R" class="external-link"><code>tidyverse/googledrive/R/drive_auth.R</code></a>. That is a good template for how to use gargle to manage auth in a client package. In addition, the docs for these gargle-backed functions are generated automatically from standard information maintained in the gargle package.</p>
<ul>
<li>
<code>drive_token()</code> retrieves the current credential, in a form that is ready for inclusion in HTTP requests. If <code>auth_active</code> is <code>TRUE</code> and <code>cred</code> is <code>NULL</code>, <code>drive_auth()</code> is called to obtain a credential. If <code>auth_active</code> is <code>FALSE</code>, <code>NULL</code> is returned; client packages should be designed to fall back to including an API key in affected HTTP requests, if sensible for the API.</li>
<li>
<code>drive_auth()</code> ensures we are dealing with an authenticated user and have a credential on hand with which to place authorized requests. Sets <code>auth_active</code> to <code>TRUE</code>. Can be called directly, but <code>drive_token()</code> will also call it as needed.</li>
<li>
<code>drive_deauth()</code> clears the current token. It might also toggle <code>auth_active</code>, depending on the features of the target API. See below.</li>
<li>
<code>drive_oauth_app()</code> returns <code>.auth$app</code>.</li>
<li>
<code>drive_api_key()</code> returns <code>.auth$key</code>.</li>
<li>
<code>drive_auth_configure()</code> can be used to configure auth. This is how an advanced user would enter their own OAuth app and API key into auth config, in order to affect all subsequent requests.</li>
<li>
<code>drive_user()</code> reports some information about the user associated with the current token. The Drive API offers an actual endpoint for this, which is not true for most Google APIs. Therefore the analogous function in bigrquery, <code>bq_user()</code> is a better general reference.</li>
</ul>
</div>
<div class="section level2">
<h2 id="de-auth">De-auth<a class="anchor" aria-label="anchor" href="#de-auth"></a>
</h2>
<p>APIs split into two classes: those that can be used, at least partially, without a token and those that cannot. If an API is usable without a token – which is true for the Drive API – then requests must include an API key. Therefore, the auth design for a client package is different for these two types of APIs.</p>
<p>For an API that can be used without a token: <code>drive_deauth()</code> can be used at any time to enter a de-authorized state. It sets <code>auth_active</code> to <code>FALSE</code> and <code>.auth$cred</code> to <code>NULL</code>. In this state, requests are sent out with an API key and no token. This is a great way to eliminate any friction re: auth if there’s no need for it, i.e. if all requests are for resources that are world readable or available to anyone who knows how to ask for it, such as files shared via “Anyone with the link”. The de-authorized state is especially useful in non-interactive settings or where user interaction is indirect, such as via Shiny.</p>
<p>For an API that cannot be used without a token: BigQuery is an example of such an API. <code>bq_deauth()</code> just clears the current token, so that the auth flow starts over the next time a token is needed.</p>
</div>
<div class="section level2">
<h2 id="byoak-bring-your-own-app-and-key">BYOAK = Bring Your Own App and Key<a class="anchor" aria-label="anchor" href="#byoak-bring-your-own-app-and-key"></a>
</h2>
<p>Advanced users can use their own OAuth app and API key. <code>drive_auth_configure()</code> lives in <code>R/drive_auth()</code> and it provides the ability to modify the current <code>app</code> and <code>api_key</code>. Recall that <code>drive_oauth_app()</code> and <code>drive_api_key()</code> also exist for targeted, read-only access.</p>
<p>The vignette <a href="https://gargle.r-lib.org/articles/get-api-credentials.html">How to get your own API credentials</a>” describes how to an API key and OAuth app.</p>
<p>Packages that always send token will omit the API key functionality here.</p>
</div>
<div class="section level2">
<h2 id="changing-identities-and-more">Changing identities (and more)<a class="anchor" aria-label="anchor" href="#changing-identities-and-more"></a>
</h2>
<p>One reason for a user to call <code>drive_auth()</code> directly and proactively is to switch from one Google identity to another or to make sure they are presenting themselves with a specific identity. <code>drive_auth()</code> accepts an <code>email</code> argument, which is honored when gargle determines if there is already a suitable token on hand. Here is a sketch of how a user could switch identities during a session, possibly non-interactive:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>email <span class="op">=</span> <span class="st">"janedoe_work@gmail.com"</span><span class="op">)</span></span>
<span><span class="co"># do stuff with Google Drive here, with Jane Doe's "work" account</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>email <span class="op">=</span> <span class="st">"janedoe_personal@gmail.com"</span><span class="op">)</span></span>
<span><span class="co"># do other stuff with Google Drive here, with Jane Doe's "personal" account</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/path/to/a/service-account.json"</span><span class="op">)</span></span>
<span><span class="co"># do other stuff with Google Drive here, using a service account</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

  </div></footer>
</body>
</html>
