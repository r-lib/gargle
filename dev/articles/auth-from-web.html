<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Auth when using R from the browser • gargle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Auth when using R from the browser">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.6.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a></li>
    <li><a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a></li>
    <li><a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R from the browser</a></li>
    <li><a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Auth when using R from the browser</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/main/vignettes/auth-from-web.Rmd" class="external-link"><code>vignettes/auth-from-web.Rmd</code></a></small>
      <div class="d-none name"><code>auth-from-web.Rmd</code></div>
    </div>

    
    
<p>If you are working with R in a web-based context, such as <a href="https://posit.co/download/rstudio-server/" class="external-link">RStudio Server</a>, <a href="https://posit.cloud/" class="external-link">Posit Cloud</a>, <a href="https://posit.co/products/enterprise/workbench/" class="external-link">Posit
Workbench</a>, or <a href="https://colab.research.google.com/" class="external-link">Google
Colaboratory</a>, your experience of browser-based auth flows will be
different from those using R on their local machine. You need to use
<strong>out-of-band authentication</strong>, sometimes denoted “oob” or
“OOB”. After the usual auth dance, instead of seeing “authentication
successful, return to R!”, you are presented with an authorization code
to copy and paste back into your R session. For folks who are running R
on their local machine, this final exchange can be done automagically,
using a temporary local webserver, but that is not possible for those
accessing a remote R session through the browser.</p>
<p>On February 16, 2022, Google announced the (partial) deprecation of
the OAuth out-of-band (OOB) flow, to be enacted no later than February
1, 2023. The deprecation applies to Google Cloud Platform (GCP) projects
that are in production mode. OOB still works for projects that are in
testing mode.</p>
<p>The built-in tidyverse client (used by googledrive, googlesheets4,
and bigrquery) is associated with a GCP project that is in production
mode. Therefore, conventional OOB auth stopped working for the built-in
client in February 2023. In anticipation of this, gargle gained a new
auth flow in version 1.3.0 that we call “pseudo-OOB”, which should allow
casual users to continue to enjoy a low-friction auth experience, even
from RStudio Server, Posit Cloud, Posit Workbench, and Google
Colaboratory.</p>
<p>If you attempt to do conventional OOB auth with a client that no
longer supports it, you’ll see something like this:</p>
<div class="figure">
<img src="invalid_request.png" alt="Screenshot with the following text: 'Access blocked: Tidyverse API Packages's request is invalid', 'You can't sign in because Tidyverse API Packages sent an invalid request. You can try again later, or contact the developer about this issue. Learn more about this error', 'If you are a developer of Tidyverse API Packages, see error details.', 'Error 400: invalid_request'." width="400px"><p class="caption">
Access blocked: Tidyverse API Packages’s request is invalid. Error 400:
invalid_request
</p>
</div>
<p>If you work on any of the affected platforms and are experiencing new
auth problems, your first move should be to update all packages involved
(gargle and one or more of googledrive, googlesheets4, bigrquery).
<strong>Restart R.</strong> Re-execute your code in an interactive
context that will allow you to re-auth.</p>
<p>This vignette documents various matters around OOB auth, both
conventional and pseudo-OOB, for users who want to understand this more
deeply.</p>
<p>Some of the packages that use gargle for auth and for which this
article applies:</p>
<ul>
<li><a href="https://bigrquery.r-dbi.org" class="external-link">bigrquery</a></li>
<li><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></li>
<li><a href="https://googlesheets4.tidyverse.org" class="external-link">googlesheets4</a></li>
<li>
<a href="https://gmailr.r-lib.org" class="external-link">gmailr</a> <em>note: gmailr does
not use the built-in tidyverse OAuth client</em>
</li>
</ul>
<div class="section level2">
<h2 id="consider-using-a-service-account-token-or-no-token">Consider using a service account token (or no token!)<a class="anchor" aria-label="anchor" href="#consider-using-a-service-account-token-or-no-token"></a>
</h2>
<p>If you have concerns about using OOB auth, consider whether your task
truly requires auth as a specific, normal user.</p>
<p>Can the task be completed with <em>no auth</em>, i.e. you are
accessing something that is world readable or readable for “anyone with
a link”? In that case, the wrapper package probably provides a function
to go into a de-authorized state, such as
<code>googledrive::drive_deauth()</code> or
<code>googlesheets4::gs4_deauth()</code>.</p>
<p>If the task requires auth, consider whether it really must be as a
specific user. You may be able to accomplish the task with a service
account, which you create for this specific purpose. A service account
token is much easier to work with on a server and in non-interactive
contexts than a user token. A service account can also be given much
more selective permissions than a user account and can be more easily
deleted, once it is no longer needed. Remember that the service account
will need to be explicitly given permission to access any necessary
resources (e.g. permission to read or write a specific Drive file or
Sheet). A service account doesn’t somehow inherit permissions indirectly
from the user who owns the GCP project in which it lives. To learn more
about using a service account, see
<code><a href="../articles/non-interactive-auth.html">vignette("non-interactive-auth")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="when-and-how-to-use-oob">When and how to use OOB<a class="anchor" aria-label="anchor" href="#when-and-how-to-use-oob"></a>
</h2>
<p>In the absence of any user instructions, the function
<code><a href="../reference/gargle_options.html">gargle::gargle_oob_default()</a></code> is used to decide whether to
use OOB auth. By default, OOB auth is used on RStudio Server, Posit
Cloud, Posit Workbench, and Google Colaboratory, or if the option
<code>"gargle_oob_default"</code> is set to <code>TRUE</code>. (Note
that we use the term “OOB auth” here to include both the existing,
conventional form of OOB and gargle’s new pseudo-OOB.)</p>
<p>Wrapper packages generally also allow the user to opt-in to OOB auth
when making a direct call to an auth function. For example, the
functions <code>googledrive::drive_auth()</code>,
<code>googlesheets4::gs4_auth()</code>,
<code>bigrquery::bq_auth()</code>, and <code>gmailr::gm_auth()</code>
all have a <code>use_oob</code> argument. Notably, all of these
<code>use_oob</code> arguments default to
<code><a href="../reference/gargle_options.html">gargle::gargle_oob_default()</a></code>.</p>
<p>gargle usually automatically detects when it should use OOB auth, but
here is what it could look like if we are not using OOB, but should be.
During auth, you are redirected to localhost on port 1410 and receive an
error along these lines:</p>
<pre><code>Chrome: This site can't be reached; localhost refused to connect.
Firefox: Unable to connect; can't establish a connection.</code></pre>
<p>If this happens you might need to explicitly request OOB. Below we
review two different methods.</p>
</div>
<div class="section level2">
<h2 id="request-oob-auth-in-the-pkg_auth-call">Request OOB auth in the <code>PKG_auth()</code> call<a class="anchor" aria-label="anchor" href="#request-oob-auth-in-the-pkg_auth-call"></a>
</h2>
<p>Packages like googledrive and bigrquery aim to make auth “just work”
for most users, i.e. it’s automatically triggered upon first need.
However, it is always possible to initiate auth yourself, which gives
you the opportunity to specify non-default values of certain parameters.
Here’s how you could request OOB auth, using googledrive as an
example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://googledrive.tidyverse.org" class="external-link">googledrive</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">drive_auth</span><span class="op">(</span>use_oob <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now carry on with your work</span></span>
<span><span class="fu">drive_find</span><span class="op">(</span>n_max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-the-gargle_oob_default-option">Set the <code>"gargle_oob_default"</code> option<a class="anchor" aria-label="anchor" href="#set-the-gargle_oob_default-option"></a>
</h2>
<p>If you know that you <em>always</em> want to use OOB, as a user or
within a project, the best way to express this is to set the
<code>"gargle_oob_default"</code> option.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>gargle_oob_default <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This code could appear at the top of a script, in a setup chunk for
<code>.Rmd</code>, or in a Shiny app. But it probably makes even more
sense in a <code>.Rprofile</code> startup file, at the user or project
level.</p>
<p>Once the <code>"gargle_oob_default"</code> option has been set, it is
honored by downstream calls to <code>PKG_auth()</code>, explicit or
implicit, because the default value of <code>use_oob</code> is
<code><a href="../reference/gargle_options.html">gargle::gargle_oob_default()</a></code>, which consults the
option.</p>
</div>
<div class="section level2">
<h2 id="conventional-vs--pseudo-oob-auth">Conventional vs. pseudo-OOB auth<a class="anchor" aria-label="anchor" href="#conventional-vs--pseudo-oob-auth"></a>
</h2>
<p>gargle now supports two OOB flows, which we call “conventional OOB”
(the existing, legacy OOB flow) and “pseudo-OOB” (the new flow
introduced in response to the partial deprecation of conventional OOB).
If we are using OOB auth, the decision between conventional or
pseudo-OOB is made based on the currently configured OAuth client.</p>
<ul>
<li>If the OAuth client is of type <code>"installed"</code> (shows as
“Desktop” in Google Cloud Console) or is of unknown type, gargle uses
conventional OOB. Note that this will not necessarily succeed, due to
the deprecation process described above.</li>
<li>If the OAuth client is of type <code>"web"</code> (shows as “Web
application” in Google Cloud Console), gargle uses the new pseudo-OOB
flow.</li>
</ul>
<style>
  table {
    border-collapse: collapse;
    border-style: none;
  }

  .empty-cell {
    border: none;
    background-color: transparent;
  }

  table thead {
    background-color: transparent;
  }

  table th, table td {
    border-style: solid;
  }
</style>
<table class="table">
<thead>
<tr>
<th class="empty-cell"></th>
      <th class="empty-cell"></th>
      <th colspan="2"><verb>use_oob</verb></th>
    </tr>
<tr>
<th class="empty-cell"></th>
      <th class="empty-cell"></th>
      <th>FALSE</th>
      <th>TRUE</th>
    </tr>
</thead>
<tbody>
<tr>
<th rowspan="2">client type</th>
      <th>installed</th>
      <td>use httpuv to spin up<br> a temporary web server</td>
      <td>conventional OOB</td>
    </tr>
<tr>
<th>web</th>
      <td>--not possible--</td>
      <td>pseudo-OOB</td>
    </tr>
</tbody>
</table>
<p>Packages that use a built-in tidyverse OAuth client (googledrive,
googlesheets4, and bigrquery) should automatically select a “web” client
on RStudio Server, Posit Cloud, Posit Workbench, and Google Colaboratory
and an “installed” client otherwise. If you need to explicitly request a
“web” client in some other setting, you can use the global option
<code>"gargle_oauth_client_type"</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>gargle_oauth_client_type <span class="op">=</span> <span class="st">"web"</span><span class="op">)</span></span></code></pre></div>
<p>Users who configure their own OAuth client will need to be
intentional when choosing the client type, depending on where the code
is running.</p>
<p>On the R side, it is recommended to setup an OAuth client using
<code><a href="../reference/gargle_oauth_client_from_json.html">gargle_oauth_client_from_json()</a></code>, which allows the client
type (<code>"installed"</code> vs. <code>"web"</code>) to be detected
programmatically from the downloaded JSON. The less-preferred approach
is to use <code><a href="../reference/gargle_oauth_client_from_json.html">gargle_oauth_client()</a></code> and provide the information
yourself.</p>
</div>
<div class="section level2">
<h2 id="how-pseudo-oob-works">How pseudo-OOB works<a class="anchor" aria-label="anchor" href="#how-pseudo-oob-works"></a>
</h2>
<p>Pseudo-OOB works just like non-OOB and conventional OOB in terms of
the user’s interactions with Google authorization server. This is where
the user authenticates themselves with Google and consents to the type
of access being requested by the R code.</p>
<p>These flows differ in how they handle a successful response from the
authorization server. Specifically, the flows use different redirect
URIs.</p>
<ul>
<li>A (temporary) local webserver is used to listen for this response
at, e.g., <code>http://localhost:1410/</code> if R is running locally
and the httpuv package is available (i.e. a non-OOB flow).</li>
<li>In conventional OOB, a special redirect value is used, typically
<code>urn:ietf:wg:oauth:2.0:oob</code>, and the authorization code is
provided to the user via a browser window for manual copy/paste. This
page is served by Google. Google has deprecated conventional OOB for
projects in production mode (but it is still allowed for projects in
testing mode).</li>
<li>In gargle’s pseudo-OOB, a redirect URI from the configured OAuth
client is used to receive the response. This page is responsible for
exposing a code that the user can copy/paste, similar to conventional
OOB (except the page is <em>not</em> served by Google). Unlike
conventional OOB, this is not the authorization code itself, but is
something from which the code can be extracted, along with a state token
to mitigate cross-site request forgery. This is actually implemented
using an <a href="https://developers.google.com/identity/protocols/oauth2/web-server" class="external-link">OAuth
flow for web server applications</a>. Note that we (gargle) call this
pseudo-OOB, but it is not technically OOB from Google’s
point-of-view.</li>
</ul>
<p>The built-in OAuth client used for pseudo-OOB by tidyverse packages
redirects to <a href="https://www.tidyverse.org/google-callback/" class="external-link uri">https://www.tidyverse.org/google-callback/</a>. This is a
static landing page that does not collect any data and exists solely to
give the interactive R user a way to convey the authorization token back
to the waiting R process and thereby complete the auth process.</p>
<div class="section level3">
<h3 id="more-details-about-the-deprecation-of-conventional-oob">More details about the deprecation of conventional OOB<a class="anchor" aria-label="anchor" href="#more-details-about-the-deprecation-of-conventional-oob"></a>
</h3>
<p>Key links:</p>
<ul>
<li>Blog post: <a href="https://developers.googleblog.com/2022/02/making-oauth-flows-safer.html" class="external-link">Making
Google OAuth interactions safer by using more secure OAuth
flows</a>
</li>
<li><a href="https://developers.google.com/identity/protocols/oauth2/resources/oob-migration#web-application" class="external-link">Out-Of-Band
(OOB) flow Migration Guide</a></li>
<li><a href="https://developers.google.com/identity/protocols/oauth2" class="external-link">Using
OAuth 2.0 to Access Google APIs</a></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="but-i-didnt-need-oob-yesterday">But I didn’t need OOB yesterday!<a class="anchor" aria-label="anchor" href="#but-i-didnt-need-oob-yesterday"></a>
</h2>
<p>Sometimes the usual OAuth web flow suddenly stops working for people
working directly with R (so NOT via the browser) and they use OOB auth
to get unstuck again. What’s going on in this case?</p>
<p>The initial error looks something like this:</p>
<pre><code>createTcpServer: address already in use
Error in httpuv::startServer(use$host, use$port, list(call = listen)) :
  Failed to create server</code></pre>
<p>It’s characteristic of some other process sitting on port 1410, which
is what gargle is trying to use for auth.</p>
<p>It’s true that using OOB auth is a workaround. But OOB auth is,
frankly, more clunky, so why use it if you don’t have to? Here are ways
to fix this.</p>
<ul>
<li>Restart your system. This will almost certainly kill the offending
process, which is usually a zombie process.</li>
<li>Hunt down the offending process, verify it looks expendable, and
kill it.</li>
</ul>
<p>On *nix-y systems, use <code>lsof</code> to get the process ID:</p>
<pre><code>sudo lsof -i :1410</code></pre>
<p>The output will look something like this:</p>
<pre><code>COMMAND   PID  USER   FD   TYPE            DEVICE SIZE/OFF NODE NAME
R       16664 jenny   20u  IPv4 0x63761a50856c65f      0t0  TCP localhost:hiq (LISTEN)</code></pre>
<p>In this case, as is typical, this is a zombie R process and I feel
confident killing it. The process ID is listed there as PID. Note that
and kill the process, like so, filling in the PID you found:</p>
<pre><code>kill -9 &lt;PID&gt;</code></pre>
<p>So, to be clear, in this example, the command would be:</p>
<pre><code>kill -9 16664</code></pre>
<p>The normal, non-OOB auth web flow should work again now.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>If you’re working on a data product that will be deployed (for
example on <a href="https://www.shinyapps.io" class="external-link">shinyapps.io</a> or <a href="https://posit.co/products/enterprise/connect/" class="external-link">Posit Connect</a>),
you will also need to consider how the deployed content will
authenticate non-interactively, which is covered in
<code><a href="../articles/non-interactive-auth.html">vignette("non-interactive-auth")</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
